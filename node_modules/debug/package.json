const { chromium } = require('playwright');
const fs = require('fs');
const path = require('path');

const outputPath = path.join(__dirname, '../public/data/reviews_baemin.json');
const screenshotPath = path.join(__dirname, '../debug/review_debug.png');

// 쿠키 값 문자열 필드만 포함되어야 함
const cookies = [
  {
    name: '__cf_bm',
    value: 'Sm56JjgqMeeuidhOhwtugw2gThHQqtOSXC3bcuMkg6o-1745124121-1.0.1.1-gk15fsNgTn8rjuCU_jKXRx2iRyNoHQQNGZg7NpJ47x428L9mnjX1yneLDdcG586fGtluj3BZWUlE7okI9wBaoD_l6JtTfsd8jFCoPg38wW7PCy8LWskFzU_Sgmmiqm1Z',
    domain: '.baemin.com',
    path: '/',
    httpOnly: true,
    secure: true
  }
];

(async () => {
  const browser = await chromium.launch({ headless: true });
  const context = await browser.newContext();
  const page = await context.newPage();

  try {
    // 💾 디버그 폴더 생성
    fs.mkdirSync(path.dirname(screenshotPath), { recursive: true });

    console.log("🔐 쿠키 삽입 후 로그인 페이지 진입...");
    await context.addCookies(cookies);
    await page.goto('https://self.baemin.com/shops/14137597/reviews', { timeout: 60000 });
    console.log("📍 현재 페이지 URL:", page.url());

    // 페이지 로딩 확인
    const html = await page.content();
    console.log("🧾 HTML 로딩 성공. 길이:", html.length);

    // 강제 스크롤
    await page.evaluate(() => window.scrollBy(0, 1500));
    console.log("📜 강제 스크롤 완료, 3초 대기...");
    await page.waitForTimeout(3000);

    // 텍스트 로깅 시도
    const bodyText = await page.textContent('body');
    if (bodyText && bodyText.includes('리뷰')) {
      console.log("✅ '리뷰' 텍스트 존재함");
    } else {
      console.log("❌ 리뷰 관련 텍스트 미표시");
    }

    // 리뷰 수집 시도
    const reviews = await page.$$eval('div.ReviewContent-module__Ksg4', cards => {
      return cards.map(card => ({
        text: card.innerText.trim(),
        image: card.querySelector('img')?.src || null
      }));
    });

    console.log("✅ 수집된 리뷰 수:", reviews.length);

    // 리뷰 저장
    fs.mkdirSync(path.dirname(outputPath), { recursive: true });
    fs.writeFileSync(outputPath, JSON.stringify(reviews, null, 2), 'utf-8');
    console.log("📁 리뷰 저장 완료:", outputPath);
  } catch (err) {
    console.error("❌ 리뷰 수집 오류:", err.message);
  }

  try {
    // 📸 스크린샷 저장
    await page.screenshot({ path: screenshotPath, fullPage: true });
    console.log("📸 스크린샷 저장 완료:", screenshotPath);
  } catch (err) {
    console.error("❌ 스크린샷 저장 실패:", err.message);
  }

  await browser.close();
})();
