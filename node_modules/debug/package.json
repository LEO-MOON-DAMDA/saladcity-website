const { chromium } = require('playwright');
const fs = require('fs');
const path = require('path');

const outputPath = path.join(__dirname, '../public/data/reviews_baemin.json');
const screenshotPath = path.join(__dirname, '../debug/review_debug.png');

// ì¿ í‚¤ ê°’ ë¬¸ìì—´ í•„ë“œë§Œ í¬í•¨ë˜ì–´ì•¼ í•¨
const cookies = [
  {
    name: '__cf_bm',
    value: 'Sm56JjgqMeeuidhOhwtugw2gThHQqtOSXC3bcuMkg6o-1745124121-1.0.1.1-gk15fsNgTn8rjuCU_jKXRx2iRyNoHQQNGZg7NpJ47x428L9mnjX1yneLDdcG586fGtluj3BZWUlE7okI9wBaoD_l6JtTfsd8jFCoPg38wW7PCy8LWskFzU_Sgmmiqm1Z',
    domain: '.baemin.com',
    path: '/',
    httpOnly: true,
    secure: true
  }
];

(async () => {
  const browser = await chromium.launch({ headless: true });
  const context = await browser.newContext();
  const page = await context.newPage();

  try {
    // ğŸ’¾ ë””ë²„ê·¸ í´ë” ìƒì„±
    fs.mkdirSync(path.dirname(screenshotPath), { recursive: true });

    console.log("ğŸ” ì¿ í‚¤ ì‚½ì… í›„ ë¡œê·¸ì¸ í˜ì´ì§€ ì§„ì…...");
    await context.addCookies(cookies);
    await page.goto('https://self.baemin.com/shops/14137597/reviews', { timeout: 60000 });
    console.log("ğŸ“ í˜„ì¬ í˜ì´ì§€ URL:", page.url());

    // í˜ì´ì§€ ë¡œë”© í™•ì¸
    const html = await page.content();
    console.log("ğŸ§¾ HTML ë¡œë”© ì„±ê³µ. ê¸¸ì´:", html.length);

    // ê°•ì œ ìŠ¤í¬ë¡¤
    await page.evaluate(() => window.scrollBy(0, 1500));
    console.log("ğŸ“œ ê°•ì œ ìŠ¤í¬ë¡¤ ì™„ë£Œ, 3ì´ˆ ëŒ€ê¸°...");
    await page.waitForTimeout(3000);

    // í…ìŠ¤íŠ¸ ë¡œê¹… ì‹œë„
    const bodyText = await page.textContent('body');
    if (bodyText && bodyText.includes('ë¦¬ë·°')) {
      console.log("âœ… 'ë¦¬ë·°' í…ìŠ¤íŠ¸ ì¡´ì¬í•¨");
    } else {
      console.log("âŒ ë¦¬ë·° ê´€ë ¨ í…ìŠ¤íŠ¸ ë¯¸í‘œì‹œ");
    }

    // ë¦¬ë·° ìˆ˜ì§‘ ì‹œë„
    const reviews = await page.$$eval('div.ReviewContent-module__Ksg4', cards => {
      return cards.map(card => ({
        text: card.innerText.trim(),
        image: card.querySelector('img')?.src || null
      }));
    });

    console.log("âœ… ìˆ˜ì§‘ëœ ë¦¬ë·° ìˆ˜:", reviews.length);

    // ë¦¬ë·° ì €ì¥
    fs.mkdirSync(path.dirname(outputPath), { recursive: true });
    fs.writeFileSync(outputPath, JSON.stringify(reviews, null, 2), 'utf-8');
    console.log("ğŸ“ ë¦¬ë·° ì €ì¥ ì™„ë£Œ:", outputPath);
  } catch (err) {
    console.error("âŒ ë¦¬ë·° ìˆ˜ì§‘ ì˜¤ë¥˜:", err.message);
  }

  try {
    // ğŸ“¸ ìŠ¤í¬ë¦°ìƒ· ì €ì¥
    await page.screenshot({ path: screenshotPath, fullPage: true });
    console.log("ğŸ“¸ ìŠ¤í¬ë¦°ìƒ· ì €ì¥ ì™„ë£Œ:", screenshotPath);
  } catch (err) {
    console.error("âŒ ìŠ¤í¬ë¦°ìƒ· ì €ì¥ ì‹¤íŒ¨:", err.message);
  }

  await browser.close();
})();
